<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>KahramanAI-RPA</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}?v=1.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Load Cognito Identity SDK -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.2.0/dist/amazon-cognito-identity.min.js"></script>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Font Awesome 6 CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Static JS files -->
    <script src="{{ url_for('static', filename='js/util.js') }}?v=1.01"></script>
    <script src="{{ url_for('static', filename='js/param.js') }}?v=1.01"></script>

    <!-- Static CSS files -->
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}?v=1.0" />
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/receipts.css') }}?v=1.0" />

    <style>
        #uploadList {
            overflow-y: auto;
            height: calc(100vh - var(--top-offset) - 50px);
        }
    </style>

</head>
<body>

    <nav class="nav-common nav-receipts navbar navbar-expand-lg navbar-dark bg-dark border-bottom shadow-sm" data-cid="{{ customer_id }}">
        <div class="container-fluid justify-content-between"> 
            <a class="navbar-brand" href="#">Kahraman <span class="fw-bold">AI</span></a>
        </div>
        <!-- Navbar by config.js -->
    </nav>

    <div id="div-token" data-token="{{token}}" data-bid="{{bundle_id}}"></div>


    <div id="div-src" data-receiptIconUrl="{{ url_for('static', filename='images/receipt_icon.png') }}?v=1.0" data-loadingGifUrl="{{ url_for('static', filename='images/ajax_loader_arrows.gif') }}?v=1.0"></div>

    <div class="d-flex justify-content-start align-items-center p-3">

        <div class="ms-2" id="div-back-to-customer" style="display: none;">
            <button class="btn btn-outline-secondary mb-2" type="button" title="Etiketler" onclick="history.back()" style="cursor: pointer;">
                <i class="bi bi-arrow-left-square"></i>
            </button>
        </div>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('shr') && urlParams.get('shr') === 'bundle'){
                document.getElementById("div-back-to-customer").style.display = "none";
            }else{
                document.getElementById("div-back-to-customer").style.display = "block";
            }
        </script>

        <div class="ms-2" id="bundle-set" data-id="{{ bundle_id }}">
            <button class="btn btn-outline-secondary mb-2" type="button" title="Etiketler" style="cursor: pointer;">...</button>
        </div>
        

        <div class="ms-2">
            <button class="btn btn-outline-secondary mb-2" type="button" title="Tabloyu Yenile" onclick="fetchReceipts()" style="cursor: pointer;">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>

        <div class="ms-2">
            <button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#div-text-filter">
                <i class="bi bi-search"></i>
            </button>
        </div>

        <div class="ms-2" title="Mükerrer Yüklemeleri Göster">
            <button class="btn btn-outline-secondary mb-2" type="button" id="btn-show-duplicates" onclick="showDuplicateReceipts()" title="Mükerrer Yüklemeleri Göster">
                <i class="bi bi-copy"></i><span class="ms-1"></span>
            </button>
        </div>

        <div class="ms-2" title="Mükerrer Yüklemeleri Göster">
            <button class="btn btn-outline-secondary mb-2" type="button" id="btn-show-duplicates" onclick="clickedDownloadCsv()" title="Dışa Aktar (CSV) - Excel ile açabilirsiniz">
                <i class="bi bi-cloud-download"></i><span class="ms-1"></span>
            </button>
        </div>

        <div class="ms-5">
            <button class="btn btn-outline-secondary mb-2" type="button" title="Paylaşım Linki" id="btn-for-shared-link">
                <i class="bi bi-link"></i>
            </button>
        </div>
        

        <div id="div-summaryMetrics" class="d-flex ms-3" style="gap: 10px;">
            
        </div>

        <div class="ms-auto d-none" id="div-receiptFilterButtons">
            <button class="btn btn-warning receipt-filter-btn ms-1 active" id="btn-rcp-toplam" type="button" onclick="showPendingCheckedReceipts(this)" title="Toplam Belge (Kayıt edilen ve bekleyen belgeler)">...</button>
            <button class="btn btn-outline-primary receipt-filter-btn ms-1" id="btn-rcp-pending" type="button" onclick="showPendingReceipts(this)" title="Kayıt Edilmeyi Bekleyenler">...</button>
            <button class="btn btn-success receipt-filter-btn ms-1" id="btn-rcp-checked" type="button" onclick="showCheckedReceipts(this)" title="Kayıt Edilenler">...</button>
            <button class="btn btn-info receipt-filter-btn ms-1" id="btn-rcp-incomplete" type="button" onclick="showIncompleteReceipts(this)" title="Eksik Veri Olan Belgeler">...</button>
            <button class="btn btn-secondary receipt-filter-btn ms-1" id="btn-rcp-no-use" type="button" onclick="showNoUseReceipts(this)" title="Geçersiz Belgeler">...</button>
        </div>

        <!-- Right-aligned month input -->
        <div class="ms-auto">
            <input type="month" id="monthInput" name="month" class="form-control">
        </div>
    </div>

    <div class="collapse" id="div-text-filter">
        <div class="d-flex justify-content-start align-items-center px-3 pb-1">
            <div class="d-flex align-items-center gap-2"> 
                <select name="textFilterSelect" id="text-filter-select" class="form-select" title="Arama yapılacak sütun"></select>

                <input type="text" id="text-filter-input" class="form-control" placeholder="Ara..." style="width: 200px;">
                
                <button type="button" class="btn d-none" id="btn-clear-filter"  onclick="clearTableFilter()" title="Filtreyi kaldır">
                    <i class="bi bi-x-circle fs-5"></i>
                </button>
            </div>
        </div>
    </div>

    <section id="tableWrapper" class="table-response table-container p-1">

        <div class="table-scroll-container">
            <table class="table align-middle table-bordered table-hover dataTable table-sticky-header" id="receiptTable">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Firma</th>
                        <th scope="col">Vergi Dairesi</th>
                        <th scope="col">Vergi No</th>
                        <th scope="col">Belge Türü</th>
                        <th scope="col">Fatura No</th>
                        <th scope="col">Fiş No</th>
                        <th scope="col">Fatura Tarihi</th>
                        <th scope="col">Matrah</th>
                        <th scope="col">KDV Tutarı</th>
                        <th scope="col">Toplam Tutar</th>
                        <th scope="col">Oran (%)</th>
                        <th scope="col">H.Türü</th>
                        <th scope="col">Yüklendiği Tarih</th>
                        <th scope="col">Açıklama</th>
                    </tr>
                </thead>
                <tbody> 
                    <tr>
                        <td colspan="14" class="text-center">
                            <img src="{{ url_for('static', filename='images/ajax_loader_arrows.gif') }}?v=1.0" alt="Yükleniyor...">
                            <br>
                            Fatura verileri yükleniyor...
                        </td>
                    </tr>
                </tbody>
                <tfoot><tr class="d-none"></tr></tfoot>
            </table>
        </div>
    </section>

    <!-- The Modal -->
    <div class="modal fade" id="fullscreenModal" data-rid="0" data-did="0" tabindex="-1" aria-labelledby="fullscreenModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fullscreenModalLabel">Kahraman AI - RPA</h5>
                    <div class="flex-grow-1 d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-secondary" title="Önceki Belge" onclick="showPreviousOrNextReceipt(-1)">
                            <i class="bi bi-arrow-left-circle"></i>
                        </button>

                        <button class="btn btn-outline-secondary" title="Sonraki Belge" onclick="showPreviousOrNextReceipt(0)">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>

                        <button class="btn btn-outline-secondary" title="Sonraki Belge" onclick="showPreviousOrNextReceipt(1)">
                            <i class="bi bi-arrow-right-circle"></i>
                        </button>
                    </div>
                    <button type="button" onclick="hideReceiptOffcanvas()" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex gap-3">
                    <!-- Receipt Image and Navigation -->
                    <div class="div-receipt" tabindex="-1" style="width: 35%;">
                        <div class="flex-column align-items-center">
                            <div class="text-center mb-3" id="receipt-loading">
                                <img src="{{ url_for('static', filename='images/ajax_loader_arrows.gif') }}?v=1.0" id="receipt-gif" alt="Image" class="img-fluid mx-auto" width="80px">
                                <label for="receipt-gif" >Görsel Yükleniyor...</label>
                            </div>            
                            <div id="receipt-container" style="max-height: 90vh; overflow-y: auto; cursor:grab;">
                                <img src="" id="receipt-image" alt="Image" class="img-fluid mx-auto fade-image" style="max-width: 100%; display: none;">                
                            </div>
                        </div>        
                    </div>

                    <div class="d-none" id="div-image-cache" data-docid="" data-expiry="" data-url="#">
                        <img src="" alt="">
                    </div>
                        
                    <!-- Receipt Details -->
                    <div class="div-receipt" tabindex="-1" >

                        <div style="height: 30px; width: 90%;" id="progressBarContainer2" class="text-center mx-auto">
                            <img src="{{ url_for('static', filename='images/ajax_tree.gif') }}?v=1.0" alt="Image" class="img-fluid mx-auto" width="30px">
                        </div>

                        <div id="receiptDetails" class="offcanvas-body">
                            <div class="d-flex border-bottom pb-2">
                                <div style="display: flex;" id="div-receiptIdx" data-idx="0">
                                    <!-- Not used -->
                                </div>

                                <div class="post-data d-none">
                                    <div class="d-flex gap-4">   
                                        <div>Zoom:
                                            <select id="zoomSelect" style="padding: 4px;" title="Zoom">
                                                <option value="0.80">%80</option>
                                                <option value="1" selected>%100</option>
                                                <option value="1.5">%150</option>
                                                <option value="2">%200</option>
                                                <option value="3">%300</option>
                                            </select>                        
                                        </div>
                                        <div>                    
                                            <input class="form-check-input custom-visible" type="checkbox" value="" id="kontrolCheckBox" onchange="setKontrolStatus()" title="Muhasebe yazılımında kayıt edildi.">
                                            <label class="form-check-label" for="kontrolCheckBox">                    
                                                <span class="text-primary">Kayıt Edildi.</span>
                                            </label>
                                        </div>
                                        <div>                    
                                            <input class="form-check-input custom-visible" type="checkbox" value="" id="chk-ind" disabled title="Bu gider için KDV indirimi yapılabiliyorsa işaretleyin. Temsil & ağırlama giderlerinde KDV indirimi yapılamaz.">
                                            <label class="form-check-label" for="chk-ind">                    
                                                <span class="text-dark">KDV İndirilebilir.</span>
                                            </label>
                                        </div>
                                        <div>                    
                                            <input class="form-check-input custom-visible" type="checkbox" value="" id="chk-kkeg" disabled title="Kanunen Kabul Edilmeyen Gider">
                                            <label class="form-check-label" for="chk-kkeg">                    
                                                <span class="text-dark">KKEG</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-check mt-3 d-none" style="padding-left: 1px;">
                                <div class="d-flex">
                                    <div>
                                        <label for="sel-receipt-oran" class="form-label fw-semibold">Oran:</label>
                                        <select name="receipt-oran" id="sel-receipt-oran" style="padding: 3px;" disabled>
                                            <!-- Yüzdelik oran seçenekleri buraya eklenecek in ortak.js-->                            
                                        </select>
                                    </div> 
                                    <div class="ms-5">
                                        <label for="sel-expense-type" class="form-label fw-semibold">Harcama Türü:</label>
                                        <select name="expense-type" id="sel-expense-type" style="padding: 3px;" disabled>
                                            <!-- Harcama kalemleri seçenekleri buraya eklenecek in ortak.js-->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <table id="receiptsDataTable" class="rcpTable mt-2" data-loading="0" style="width: 500px;">                
                                <tbody>
                                    <tr>
                                        <td class="rcpLabel"><span>Firma:</span> </td>
                                        <td class="rcpValue" id="rcp-firm" data-field="firm"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel"><span>Adres:</span></td>
                                        <td class="rcpValue" id="rcp-addr" data-field="addr"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Tarih:</td>
                                        <td class="rcpValue" id="rcp-date" data-field="date"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr class="d-none">
                                        <td class="rcpLabel">Saat:</td>
                                        <td class="rcpValue" id="rcp-time" data-field="time"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">KDV Tutarı:</td>
                                        <td class="rcpValue" id="rcp-kdv" data-field="kdv"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Toplam</td>
                                        <td class="rcpValue" id="rcp-total" data-field="total"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Fatura No:</td>
                                        <td class="rcpValue" id="rcp-inv_no" data-field="inv_no"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Fiş No:</td>
                                        <td class="rcpValue" id="rcp-rcp_no" data-field="rcp_no"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Belge No:</td>
                                        <td class="rcpValue" id="rcp-belge_no" data-field="rcp_belge"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Araç Plaka No:</td>
                                        <td class="rcpValue" id="rcp-pln" data-field="pln"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Vergi Dairesi:</td>
                                        <td class="rcpValue" id="rcp-vd" data-field="vd"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel"><span>Vergi No:</span></td>
                                        <td class="rcpValue" id="rcp-vn" data-field="vn"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr class="d-none">
                                        <td class="rcpLabel">Müşteri Vergi Dairesi:</td>
                                        <td class="rcpValue" id="rcp-mvd" data-field="mvd"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr class="d-none">
                                        <td class="rcpLabel">Müşteri VN:</td>
                                        <td class="rcpValue" id="rcp-mvn" data-field="mvn"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr class="vatTableTr">
                                        <td class="rcpLabel">KDV Oranları</td>
                                        <td class="tdVATtable">
                                            <div>
                                                <table id="rcpVATtable" class="rcpVATtable w-100">
                                                    <thead></thead>
                                                    <tbody></tbody>
                                                </table>
                                                
                                            </div>
                                        </td>
                                        <td class="rcpActions"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Açıklama</td>
                                        <td class="rcpValue not-editable" id="rcp-desc" data-field="desc"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr>
                                        <td class="rcpLabel">Belge Yükleme Tarihi</td>
                                        <td class="rcpValue not-editable" id="rcp-dt" data-field="dt"></td>
                                        <td class="rcpActions"></td>
                                    </tr>
                                    <tr class="d-none">
                                        <td class="rcpLabel">Belgeyi Yükleyen Kişi</td>
                                        <td class="rcpValue not-editable" id="rcp-kim" data-field="kim"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                    <tr class="d-none">
                                        <td class="rcpLabel">Değişlik için Açıklama</td>
                                        <td class="rcpValue" id="rcp-update_desc" data-field="update_desc"></td>
                                        <td class="rcpActions2"></td>
                                    </tr>
                                </tbody>
                            </table>  
                            <div class="form-check mt-3 d-none">
                                <div class="d-flex">                    
                                    <div>                        
                                        <label class="form-check-label" for="donotUseCheckBox">
                                            <span class="text-secondary">Bu belgeyi kullanma</span>
                                        </label>
                                        <input class="form-check-input custom-visible" type="checkbox" value="" id="donotUseCheckBox" disabled title="Bu belgeyi kullanmak istemiyorsanız işaretleyin">
                                    </div>
                                </div>
                            </div>          
                        </div>

                        <div class="offcanvas-body" id="ai-response"> </div>
                    </div>

                    <!-- RPA İş Akışı Modal -->
                    <div>
                        <div class="d-flex justify-content-between p-2">
                            <div class="form-check">
                                <select name="rpa-helper" id="rpa-helper" style="padding: 3px;">
                                    <option value="mouse-click">Mouse Tık</option>
                                    <option value="keyboard-today">Tarih Girişi</option>
                                    <option value="keyboard-input">Metin Girişi</option>
                                    <option value="keyboard-enter">Enter Tuşu</option>
                                    <option value="keyboard-tab">Tab Tuşu</option>
                                </select>
                                <span title="RPA iş akışına ekle" style="cursor: pointer;">
                                    <i class="bi bi-plus-circle text-success" id="addHelperAction"></i>
                                </span>
                            </div>
                            <div class="form-check ms-4">
                                <div class="">   

                                    <div>                        
                                        <label class="form-check-label" for="rrpa-minimize">
                                            <span class="text-secondary">RPA için Ekranı Küçült</span>
                                        </label>
                                        <input class="form-check-input custom-visible" type="checkbox" id="rpa-minimize" title="RPA iş akışı öncesi bu ekranı küçültmek için işaretleyiniz.">
                                    </div>
                                                     ß
                                    <div>                        
                                        <label class="form-check-label" for="rpa-edit-mode">
                                            <span class="text-secondary">Değişiklik Modu</span>
                                        </label>
                                        <input class="form-check-input custom-visible" type="checkbox" id="rpa-edit-mode" title="RPA akışında değişiklik yapmak için işaretleyiniz." onchange="enableDisableRPAeditMode(this)">
                                    </div>
                                </div>
                            </div> 
                        </div>
                        <table id="rpaTable" class="rcpTable mt-2 ms-4" data-loading="0" style="min-width: 300px;">
                            <thead>
                                <tr>
                                    <th colspan="6">RPA İŞ AKIŞI</th>
                                    <th colspan="2" class="fs-5 text-center text-success fw-bold"><i class="bi bi-play-circle" title="RPA İş Akışını Başlat" onclick="startRPAWorkflowFromButton()"></i></th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    
                </div>

                <div class="modal-footer" style="height: 10px;">

                </div>
            </div>
        </div>
    </div>


    <div id="div-src" data-receiptIconUrl="{{ url_for('static', filename='images/receipt_icon.png') }}?v=1.0"></div>

    <div id="resultMessage" style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2055; min-width: 300px; max-width: 90%; display: none;"></div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="{{ url_for('static', filename='js/rpa.js') }}?v=1.01"></script>    
    <script src="{{ url_for('static', filename='js/shr/shr_receipts.js') }}?v=1.01"></script>
    <script src="{{ url_for('static', filename='js/ortak.js') }}?v=1.01"></script>
    <script src="{{ url_for('static', filename='js/receipts.js') }}?v=1.01"></script>  
    <script src="{{ url_for('static', filename='js/receipts2.js') }}?v=1.01"></script>  
    <script src="{{ url_for('static', filename='js/shr/shr_ortak.js') }}?v=1.01"></script>
    <script src="{{ url_for('static', filename='js/shr/shr_config.js') }}?v=1.01"></script>

</body>
</html>
